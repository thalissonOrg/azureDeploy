name: Azure Web App Deployment


inputs:
  app_name:
    required: true
  credentials:
    required: true
  token:
    required: true
  resource_group:
    required: true
  artifact_workflow:
    required: true
  artifact_name:
    required: true
  package_type:
    required: false
    default: .zip
    description: Default value is .zip

env:
  WEBAPP: python-test-thali
  GROUP: tschumaher
  ACCOUNT: app_storage_account  # Does not have to exist, this will be created for you
  CONTAINER:  app_storage_container
  EXPIRY_TIME: 10 minutes

runs:
    using: 'composite'
    steps:
    - name: Azure login
      uses: azure/login@v1
      with: 
        creds: ${{ inputs.credentials }}

    - name: Downlaod artifact
      uses: Legit-Labs/action-download-artifact@v2
      with:
        name: ${{ inputs.artifact_name }}
        workflow: ${{ inputs.artifact_workflow }}
        github_token: ${{ inputs.token }}
        path: ${{ github.workspace }}

    - name: Set SAS token expiration
      run: echo "expiry=`date -u -d "$EXPIRY_TIME" '+%Y-%m-%dT%H:%MZ'`" >> $GITHUB_ENV
      shell: bash

    - name: Azure CLI script
      uses: azure/CLI@v1
      with:
        azcliversion: 2.19.1
        inlineScript: |
          az extension add --name webapp

          az storage account create   -n $ACCOUNT   -g $GROUP -l westus
          az storage container create -n $CONTAINER --account-name $ACCOUNT
          az storage blob upload      -f app.zip    --account-name $ACCOUNT -c $CONTAINER -n $ACCOUNT

          ZIP_URL=$(az storage blob generate-sas --full-uri --permissions r --expiry ${{ env.expiry }} --account-name $ACCOUNT -c $CONTAINER -n $ACCOUNT | xargs)

          az webapp deploy --name $WEBAPP --resource-group $GROUP --type zip --src-url  $ZIP_URL --async false

          az storage container delete -n $CONTAINER --account-name $ACCOUNT 
